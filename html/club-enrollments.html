<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Events</title>
    <link rel="stylesheet" href="../style/club-enrollments.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<nav class="navbar">
    <ul>
        <li><a href="home.php" class="cv"><img class="icon" src="../pics/home.png" height="28" width="28"></a></li>
        <li><a href="register.html">Registration</a></li>
        <li><a href="signin.html">Sign In</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li class="right"><a href="profile.html"><img class="user-settings" src="../pics/user.png" height="28" width="28"></a></li>
    </ul>
</nav>

<ul id="enrollments"></ul>

<script>
    axios.defaults.baseURL = 'http://localhost:8080';
    axios.defaults.withCredentials = true;

    const list = document.getElementById('enrollments');
    const xsrf = () => (document.cookie.split('; ').find(s=>s.startsWith('XSRF-TOKEN='))||'').split('=')[1] || '';
    const esc  = s => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

    async function load(){
        list.innerHTML = '<li class="card">Loading…</li>';
        try {
            const { data } = await axios.get('/club-enrollment', { headers:{ Accept:'application/json' } });
            const arr = Array.isArray(data) ? data : [data];
            if (!arr.length) {
                list.innerHTML = '<li class="card">No enrollments yet.</li>';
                return;
            }
            list.innerHTML = arr.map(e => `
          <li class="card">
            <div class="info">
              <div>
                <div style="font-weight:700">${esc([e.athlete?.firstName, e.athlete?.lastName].filter(Boolean).join(' '))}</div>
                <div style="opacity:.8">${esc(e.club?.name || e.athlete?.club?.name || '')}</div>
                <div style="opacity:.8">Status: ${esc(e.status)}</div>
              </div>
              <button class="accept" data-athlete="${e.athlete?.id ?? ''}" ${e.status==='ACCEPTED'?'disabled':''}>
                ${e.status==='ACCEPTED'?'Accepted':'Accept'}
              </button>
            </div>
            <div class="msg"></div>
          </li>
        `).join('');
        } catch(e) {
            list.innerHTML = `<li class="card error">${e.response?.status===401 ? 'Not logged in.' : 'Error.'}</li>`;
        }
    }

    list.addEventListener('click', async ev => {
        const btn = ev.target.closest('.accept'); if (!btn || btn.disabled) return;
        const msg = btn.closest('li').querySelector('.msg');
        btn.disabled = true; msg.textContent = 'Accepting…';
        try {
            await axios.patch(`/club-enrollment/${btn.dataset.athlete}/accept`, null, {
                headers:{ Accept:'application/json','X-XSRF-TOKEN': xsrf() }
            });
            btn.textContent = 'Accepted'; msg.textContent = 'Enrollment accepted ✔'; msg.className = 'msg ok';
        } catch(e) {
            msg.textContent = e.response?.status===401 ? 'Not logged in.' : 'Failed.';
            msg.className = 'msg error'; btn.disabled = false;
        }
    });

    load();
</script>

</body>
</html>