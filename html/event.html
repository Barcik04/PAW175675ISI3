<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Event</title>
    <link rel="stylesheet" href="../style/events.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
<nav class="navbar">
    <ul>
        <li><a href="home.php" class="cv"><img class="icon" src="../pics/home.png" height="28" width="28"></a></li>
        <li><a href="events.html">← Back to events</a></li>
    </ul>
</nav>

<main class="wrap">
    <div id="event-card" class="event-card">
        <h1 id="event-name">Loading…</h1>
        <p id="event-date"></p>
        <button id="enroll-btn">Enroll</button>
        <p id="status" class="status"></p>
    </div>

    <section class="wrap" style="max-width:700px;margin-top:30px">
        <h2>Participants</h2>
        <ul id="athletes" class="event-list"></ul>
    </section>
</main>

<script>
    axios.defaults.baseURL = 'http://localhost:8080';
    axios.defaults.withCredentials = true; // send JSESSIONID

    const params  = new URLSearchParams(location.search);
    const eventId = params.get('id');

    if (!eventId) {
        document.getElementById('event-card').innerHTML = '<p>Missing event id.</p>';
    } else {
        loadEvent();
        loadParticipants();
    }

    async function loadEvent() {
        const nameEl = document.getElementById('event-name');
        const dateEl = document.getElementById('event-date');
        const status = document.getElementById('status');

        try {
            const res = await axios.get(`/event/${eventId}`);
            const ev = res.data;
            nameEl.textContent = ev.name;
            dateEl.textContent = ev.date;
        } catch (err) {
            nameEl.textContent = 'Failed to load event';
            status.textContent = `Error: ${err.response?.status || err.message}`;
            document.getElementById('enroll-btn').disabled = true;
        }
    }

    async function loadParticipants() {
        const ul = document.getElementById('athletes');
        ul.innerHTML = '<li>Loading…</li>';

        try {
            const res = await axios.get(`/event/${eventId}/athletes`);
            const people = res.data;
            if (!people.length) {
                ul.innerHTML = '<li>No participants yet.</li>';
                return;
            }
            ul.innerHTML = people.map(p => `
        <li class="event-row">
          <div class="event-link" style="display:flex;justify-content:space-between">
            <span>${p.firstName} ${p.lastName}</span>
            <span>#${p.id}</span>
          </div>
        </li>
      `).join('');
        } catch (err) {
            ul.innerHTML = `<li>Failed to load participants (${err.response?.status || err.message})</li>`;
        }
    }

    document.getElementById('enroll-btn').addEventListener('click', async () => {
        const btn = document.getElementById('enroll-btn');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.textContent = 'Enrolling…';

        try {
            const res = await axios.post(`/enroll/${eventId}`);
            if (res.status === 201) {
                status.textContent = 'Enrolled ✔';
                btn.textContent = 'Enrolled';
                loadParticipants();
            }
        } catch (err) {
            const s = err.response?.status;
            if (s === 409) status.textContent = 'You are already enrolled.';
            else if (s === 401 || s === 403) status.textContent = 'Unauthorized. Please sign in1.';
            else status.textContent = `Something went wrong (${s || err.message}).`;
            btn.disabled = false;
        }
    });
</script>

</body>
</html>
